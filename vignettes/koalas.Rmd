---
title: "koalas"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{koalas}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=8, fig.height=4
)
```

## Overview

The koalas package is intended to be used for exploring chlamydia control programmes.  The package is currently in an early stage of development.

## Installation

The latest release version of the package can be installed from r-universe:

```{r eval=FALSE}
install.packages(c("koalas","tidyverse"),
  repos=c("https://ku-awdc.r-universe.dev/", "https://cran.rstudio.com/"))
```

This also installs the tidyverse package from CRAN, which is used in this vignette for plotting etc. Note that C++ compilers are NOT required for installation as long as your installed version of R is current. This should cover most use cases.

Alternatively, you can install the development version directly from GitHub.  To do that you must first pre-install the remotes package (from CRAN) and the IPDMR package (from ku-awdc.r-universe.dev/):

```{r eval=FALSE}
install.packages(c("IPDMR","remotes"),
  repos=c("https://ku-awdc.r-universe.dev/", "https://cran.rstudio.com/"))
```

Then you can install the koalas package from source:

```{r eval=FALSE}
remotes::install_github("ku-awdc/koalas")
```

Note that this last step requires C++ compilers.


## TLDR; Quick guide to running scenarios

The pre-determined scenarios are run in the following way:

```{r}
library("koalas")
model <- KoalasV2$new()
model$burnin()
```

This runs the model from 1st July 2022 up to 1st October 2025, which is where we might start doing active interventions:

```{r}
library("ggplot2")
theme_set(theme_light())

model$results_long |>
  ggplot(aes(x=Date, y=Koalas, col=Compartment)) +
  geom_line() +
  geom_hline(yintercept=c(300), lty="dotted")
```

```{r}
model$results_long |>
  ggplot(aes(x=Date, y=Percent, col=Compartment)) +
  geom_line() +
  geom_hline(yintercept=c(10,30), lty="dotted") +
  geom_vline(xintercept=as.Date("2022-07-01")+365*c(0,1,3), lty="dashed")
```

Then we can run the model for another 2 phases:

1. High-intensity sampling
2. Lower-intensity sampling

For each of these we use the run method, with specified sampling interval (any integer, including 0).  For example, we can run a high-intensity period of 2 years with twice yearly sampling:

```{r}
model$run(
  years = 2,
  sampling_frequency = 2,
  proportion = 0.75,
  cull_positive = 0.0,
  cull_acute = 0.2,
  cull_chronic = 0.3
)
```

And then another 8 years with twice yearly sampling at a lower proportion:

```{r}
model$run(
  years = 8,
  sampling_frequency = 2,
  proportion = 0.25,
  cull_positive = 0.0,
  cull_acute = 0.2,
  cull_chronic = 0.3
)
```

We can see the interventions using the interventions property:

```{r}
model$interventions
```

And also they are fairly clear on the graphs:

```{r}
model$results_long |>
  ggplot(aes(x=Date, y=Koalas, col=Compartment)) +
  geom_line() +
  geom_hline(yintercept=c(300), lty="dotted")
```

```{r}
model$results_long |>
  ggplot(aes(x=Date, y=Percent, col=Compartment)) +
  geom_line() +
  geom_hline(yintercept=c(10,30), lty="dotted") +
  geom_vline(xintercept=as.Date("2022-07-01")+365*c(0,1,3), lty="dashed")
```

And in the cumulative number of animals treated/vaccinated:

```{r}
model$treatments |>
  ggplot(aes(x=Date, y=Cumulative, col=Type)) +
  geom_line()
```



## Creating a model object

The koalas model is designed as an encapsulated object, which is created as follows:

```{r}
library("koalas")
model <- KoalasV2$new()
```

This creates a model that you can then interrogate and manipulate using the active bindings and methods supplied. For example, we can set the initial state:

```{r}
model$set_state(S=299, I=1, R=0, Af=0, Cf=0)
```

And one or more parameters:

```{r}
model$set_parameters(birthrate=0.38)
```

For a complete list of valid state and parameter values see the help file for the class:  ?KoalasV2

You can also see the current state and parameters using their active bindings:

```{r}
model$state
model$parameters
```


## Updating the model

To update the model for one or more day, use the update method with given number of days:

```{r}
model$update(21)
```

You can then extract the results so far as data frame:

```{r}
model$results_wide
```

When you want to apply an active intervention, use the active_intervention method with specified proportion of animals to test/treat/vaccinate:

```{r}
model$active_intervention(proportion=0.5)
```

You can then run for another period of time and re-extract results:

```{r}
model$update(21)
model$results_wide
```

Note that results are cumulative, i.e. you can keep updating the model and it will carry on from where it left off. This means you can apply interventions and/or change parameter values at whatever time points are required.

To re-set the model, create a new instance:

```{r}
model <- KoalasV2$new()
model$update(5)
model$results_wide
```

You can also extract aggregated results in a format more suitable for plotting:

```{r}
model$results_long
```

This produces the following (non-exclusive) combinations:

- Healthy = S+V+N+R
- Infectious = I+If+Af+Cf
- Diseased = Af+Cf
- Infertile = Sf+Vf+Nf+Rf+I+Af+Cf
- Immune = V+Vf+R+Rf+N+Nf




## Package versions

```{r}
sessionInfo()
```

